{% extends "layout_base.html" %}
{% block content %}
<div class="page page-match">

  <header class="match-header animate-fade-in">
    <div class="team">
      <img class="team-logo" src="/static/img/{{ match.team1|replace(' ', '_')|lower }}.png" alt="{{ match.team1 }}" onerror="this.style.display='none'">
      <div class="team-name">{{ match.team1 }}</div>
      <div class="team-form">{{ form1 }}</div>
    </div>

    <div class="score animate-flip" id="score-box">
      <span id="score-{{ match.id }}">{{ match.score1 }} : {{ match.score2 }}</span>
      <div class="match-time">{{ match.datetime.strftime('%d.%m %H:%M') if match.datetime else '' }}</div>
    </div>

    <div class="team">
      <img class="team-logo" src="/static/img/{{ match.team2|replace(' ', '_')|lower }}.png" alt="{{ match.team2 }}" onerror="this.style.display='none'">
      <div class="team-name">{{ match.team2 }}</div>
      <div class="team-form">{{ form2 }}</div>
    </div>
  </header>

  <section class="stream animate-slide-up">
    {% if match.stream_url %}
      <h4>Трансляция</h4>
      <div class="video-wrap">
        <iframe src="{{ match.stream_url }}" allowfullscreen frameborder="0"></iframe>
      </div>
    {% endif %}
  </section>

  <section class="players animate-fade-in">
    <div class="col">
      <h5>{{ match.team1 }}</h5>
      <ul>
        {% for p in players1 %}
          <li>{{ p.player }} — {{ p.position }} (#{{ p.number }})</li>
        {% else %}
          <li>-/-/-/-/-</li>
        {% endfor %}
      </ul>
    </div>
    <div class="col">
      <h5>{{ match.team2 }}</h5>
      <ul>
        {% for p in players2 %}
          <li>{{ p.player }} — {{ p.position }} (#{{ p.number }})</li>
        {% else %}
          <li>-/-/-/-/-</li>
        {% endfor %}
      </ul>
    </div>
  </section>

  <section class="actions animate-slide-up">
    <button id="subscribe-btn" data-match="{{ match.id }}" class="btn">
      {{ 'Отписаться от матча' if subscribed else 'Подписаться на матч' }}
    </button>

    {% if user_id == OWNER_ID %}
      <div class="admin-controls">
        <label>Редактировать счёт:</label>
        <input id="score1" type="number" value="{{ match.score1 }}" min="0">
        <input id="score2" type="number" value="{{ match.score2 }}" min="0">
        <button id="update-score" class="btn-primary" data-match="{{ match.id }}">Обновить</button>
      </div>
    {% endif %}
  </section>

  <!-- Внутреннее уведомление -->
  <div id="goal-banner" class="goal-banner hidden">
    <span class="goal-text"></span>
  </div>

</div>

<script>
document.addEventListener('DOMContentLoaded', ()=> {
  const matchId = {{ match.id }};
  const scoreEl = document.getElementById('score-'+matchId);
  const goalBanner = document.getElementById('goal-banner');

  // Подписка
  const subBtn = document.getElementById('subscribe-btn');
  subBtn.addEventListener('click', async () => {
    const action = subBtn.textContent.includes('Отпис') ? 'unsubscribe' : 'subscribe';
    const url = `/miniapp/${action}/${matchId}`;
    const res = await fetch(url, {method:'POST', headers:{'Content-Type':'application/json'}});
    const j = await res.json();
    if(j.success){
      subBtn.textContent = action === 'subscribe' ? 'Отписаться от матча' : 'Подписаться на матч';
      alert('Готово');
    } else alert('Ошибка');
  });

  // Обновление счёта (админ)
  const upd = document.getElementById('update-score');
  if(upd){
    upd.addEventListener('click', async ()=>{
      const s1 = parseInt(document.getElementById('score1').value||0);
      const s2 = parseInt(document.getElementById('score2').value||0);
      const res = await fetch('/miniapp/update_score', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({match_id: matchId, score1: s1, score2: s2})
      });
      const j = await res.json();
      if(j.success){
        // анимация табло
        const box = document.getElementById('score-box');
        box.classList.remove('animate-flip');
        void box.offsetWidth; // reset animation
        box.classList.add('animate-flip');
        scoreEl.textContent = `${s1} : ${s2}`;
        // показать баннер
        showGoalBanner(`${s1}:${s2}`);
      } else {
        alert('Ошибка: ' + (j.error || '...'));
      }
    });
  }

  function showGoalBanner(score){
    goalBanner.querySelector('.goal-text').textContent = `ГОЛ! Новый счёт: ${score}`;
    goalBanner.classList.remove('hidden');
    goalBanner.classList.add('animate-slide-down');
    setTimeout(()=>{
      goalBanner.classList.add('hidden');
      goalBanner.classList.remove('animate-slide-down');
    }, 4000);
  }
});
</script>
{% endblock %}

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å - Liga Obninska</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="/static/css/database-ui.css">
    <style>
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .admin-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .admin-section h2 {
            margin: 0 0 20px 0;
            color: #333;
            border-bottom: 2px solid #1976d2;
            padding-bottom: 8px;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #333;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .form-row {
            display: flex;
            gap: 16px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        .event-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .event-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .event-btn.goal { background: #4caf50; color: white; }
        .event-btn.assist { background: #2196f3; color: white; }
        .event-btn.yellow { background: #ff9800; color: white; }
        .event-btn.red { background: #f44336; color: white; }
        
        .current-events {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 12px;
            background: #f8f9fa;
        }
        
        .alert {
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 16px;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <h1>–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å - Liga Obninska</h1>
        
        <!-- –ê–ª–µ—Ä—Ç—ã -->
        <div id="alerts"></div>
        
        <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç–æ–º –º–∞—Ç—á–∞ -->
        <div class="admin-section">
            <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç–æ–º –º–∞—Ç—á–∞</h2>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="match-select">–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ç—á:</label>
                    <select id="match-select">
                        <option value="">–ó–∞–≥—Ä—É–∑–∫–∞ –º–∞—Ç—á–µ–π...</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="home-score">–°—á–µ—Ç —Ö–æ–∑—è–µ–≤:</label>
                    <input type="number" id="home-score" min="0" value="0">
                </div>
                <div class="form-group">
                    <label for="away-score">–°—á–µ—Ç –≥–æ—Å—Ç–µ–π:</label>
                    <input type="number" id="away-score" min="0" value="0">
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="updateMatchScore()">–û–±–Ω–æ–≤–∏—Ç—å —Å—á–µ—Ç</button>
        </div>
        
        <!-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –º–∞—Ç—á–∞ -->
        <div class="admin-section">
            <h2>–°–æ–±—ã—Ç–∏—è –º–∞—Ç—á–∞</h2>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="event-player">–ò–≥—Ä–æ–∫:</label>
                    <select id="event-player">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä–æ–∫–∞</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="event-team">–ö–æ–º–∞–Ω–¥–∞:</label>
                    <select id="event-team">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="event-minute">–ú–∏–Ω—É—Ç–∞:</label>
                    <input type="number" id="event-minute" min="0" max="120" value="0">
                </div>
                <div class="form-group">
                    <label for="event-additional">–î–æ–ø. –≤—Ä–µ–º—è:</label>
                    <input type="number" id="event-additional" min="0" max="15" value="0">
                </div>
            </div>
            
            <div class="form-group">
                <label for="event-assist">–ü–µ—Ä–µ–¥–∞—á–∞ –æ—Ç (–µ—Å–ª–∏ –≥–æ–ª):</label>
                <select id="event-assist">
                    <option value="">–ù–µ—Ç –ø–µ—Ä–µ–¥–∞—á–∏</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="event-description">–û–ø–∏—Å–∞–Ω–∏–µ:</label>
                <textarea id="event-description" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ–±—ã—Ç–∏–∏"></textarea>
            </div>
            
            <div class="event-buttons">
                <button class="event-btn goal" onclick="addEvent('goal')">‚öΩ –ì–æ–ª</button>
                <button class="event-btn assist" onclick="addEvent('assist')">üÖ∞Ô∏è –ü–µ—Ä–µ–¥–∞—á–∞</button>
                <button class="event-btn yellow" onclick="addEvent('yellow_card')">üü® –ñ–µ–ª—Ç–∞—è</button>
                <button class="event-btn red" onclick="addEvent('red_card')">üü• –ö—Ä–∞—Å–Ω–∞—è</button>
            </div>
        </div>
        
        <!-- –¢–µ–∫—É—â–∏–µ —Å–æ–±—ã—Ç–∏—è –º–∞—Ç—á–∞ -->
        <div class="admin-section">
            <h2>–¢–µ–∫—É—â–∏–µ —Å–æ–±—ã—Ç–∏—è</h2>
            <div id="current-events" class="current-events">
                <p>–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ç—á –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–æ–±—ã—Ç–∏–π</p>
            </div>
        </div>
        
        <!-- –°–æ–∑–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–∞ -->
        <div class="admin-section">
            <h2>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ –∏–≥—Ä–æ–∫–∞</h2>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="player-first-name">–ò–º—è:</label>
                    <input type="text" id="player-first-name" required>
                </div>
                <div class="form-group">
                    <label for="player-last-name">–§–∞–º–∏–ª–∏—è:</label>
                    <input type="text" id="player-last-name">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="player-username">Username:</label>
                    <input type="text" id="player-username">
                </div>
                <div class="form-group">
                    <label for="player-position">–ü–æ–∑–∏—Ü–∏—è:</label>
                    <select id="player-position">
                        <option value="">–ù–µ —É–∫–∞–∑–∞–Ω–∞</option>
                        <option value="goalkeeper">–í—Ä–∞—Ç–∞—Ä—å</option>
                        <option value="defender">–ó–∞—â–∏—Ç–Ω–∏–∫</option>
                        <option value="midfielder">–ü–æ–ª—É–∑–∞—â–∏—Ç–Ω–∏–∫</option>
                        <option value="forward">–ù–∞–ø–∞–¥–∞—é—â–∏–π</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <label for="player-telegram-id">Telegram ID:</label>
                <input type="number" id="player-telegram-id">
            </div>
            
            <button class="btn btn-success" onclick="createPlayer()">–°–æ–∑–¥–∞—Ç—å –∏–≥—Ä–æ–∫–∞</button>
        </div>
        
        <!-- –î–µ–π—Å—Ç–≤–∏—è -->
        <div class="admin-section">
            <h2>–î–µ–π—Å—Ç–≤–∏—è</h2>
            
            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                <button class="btn btn-secondary" onclick="refreshStatistics()">–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
                <button class="btn btn-secondary" onclick="loadAllData()">–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
            </div>
        </div>
    </div>

    <script src="/static/js/database-client.js"></script>
    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let currentMatch = null;
        let allMatches = [];
        let allPlayers = [];
        let allTeams = [];
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('DOMContentLoaded', async function() {
            await loadAllData();
        });
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
        async function loadAllData() {
            try {
                showAlert('–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...', 'info');
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–∞—Ç—á–∏, –∏–≥—Ä–æ–∫–æ–≤ –∏ –∫–æ–º–∞–Ω–¥—ã
                const [matchesRes, playersRes, teamsRes] = await Promise.all([
                    dbAPI.getMatches(),
                    dbAPI.getPlayers(),
                    dbAPI.getTeams()
                ]);
                
                allMatches = matchesRes.matches;
                allPlayers = playersRes.players;
                allTeams = teamsRes.teams;
                
                populateMatchSelect();
                populatePlayerSelects();
                populateTeamSelect();
                
                showAlert('–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ', 'success');
                
            } catch (error) {
                console.error('Error loading data:', error);
                showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message, 'error');
            }
        }
        
        // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –º–∞—Ç—á–µ–π
        function populateMatchSelect() {
            const select = document.getElementById('match-select');
            select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ç—á</option>';
            
            allMatches.forEach(match => {
                const option = document.createElement('option');
                option.value = match.id;
                option.textContent = `${match.home_team_name} vs ${match.away_team_name} (${DataUtils.formatMatchDate(match.match_date)})`;
                select.appendChild(option);
            });
            
            select.addEventListener('change', onMatchSelect);
        }
        
        // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–ø–∏—Å–∫–æ–≤ –∏–≥—Ä–æ–∫–æ–≤
        function populatePlayerSelects() {
            const playerSelect = document.getElementById('event-player');
            const assistSelect = document.getElementById('event-assist');
            
            playerSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä–æ–∫–∞</option>';
            assistSelect.innerHTML = '<option value="">–ù–µ—Ç –ø–µ—Ä–µ–¥–∞—á–∏</option>';
            
            allPlayers.forEach(player => {
                const option1 = document.createElement('option');
                option1.value = player.id;
                option1.textContent = DataUtils.formatPlayerName(player);
                playerSelect.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = player.id;
                option2.textContent = DataUtils.formatPlayerName(player);
                assistSelect.appendChild(option2);
            });
        }
        
        // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∫–æ–º–∞–Ω–¥
        function populateTeamSelect() {
            const select = document.getElementById('event-team');
            select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É</option>';
            
            allTeams.forEach(team => {
                const option = document.createElement('option');
                option.value = team.id;
                option.textContent = team.name;
                select.appendChild(option);
            });
        }
        
        // –í—ã–±–æ—Ä –º–∞—Ç—á–∞
        async function onMatchSelect() {
            const matchId = document.getElementById('match-select').value;
            if (!matchId) {
                currentMatch = null;
                document.getElementById('current-events').innerHTML = '<p>–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ç—á –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–æ–±—ã—Ç–∏–π</p>';
                return;
            }
            
            currentMatch = allMatches.find(m => m.id == matchId);
            if (currentMatch) {
                document.getElementById('home-score').value = currentMatch.home_score;
                document.getElementById('away-score').value = currentMatch.away_score;
                
                await loadMatchEvents(matchId);
            }
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π –º–∞—Ç—á–∞
        async function loadMatchEvents(matchId) {
            try {
                const response = await dbAPI.getMatchEvents(matchId);
                const eventsContainer = document.getElementById('current-events');
                
                if (response.events.length === 0) {
                    eventsContainer.innerHTML = '<p>–°–æ–±—ã—Ç–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
                    return;
                }
                
                const eventsHtml = response.events.map(event => `
                    <div class="event-item">
                        <div class="event-time">${event.minute}'${event.additional_time > 0 ? `+${event.additional_time}` : ''}</div>
                        <div class="event-icon">${DataUtils.getEventIcon(event.event_type)}</div>
                        <div class="event-description">
                            <strong>${DataUtils.getEventType(event.event_type)}</strong><br>
                            ${event.player_name} (${event.team_name})
                            ${event.assisted_by_name ? `<br><small>–ü–µ—Ä–µ–¥–∞—á–∞: ${event.assisted_by_name}</small>` : ''}
                            ${event.description ? `<br><small>${event.description}</small>` : ''}
                        </div>
                    </div>
                `).join('');
                
                eventsContainer.innerHTML = eventsHtml;
                
            } catch (error) {
                console.error('Error loading match events:', error);
                document.getElementById('current-events').innerHTML = '<p class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–±—ã—Ç–∏–π</p>';
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç–∞ –º–∞—Ç—á–∞
        async function updateMatchScore() {
            if (!currentMatch) {
                showAlert('–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ç—á', 'error');
                return;
            }
            
            const homeScore = parseInt(document.getElementById('home-score').value);
            const awayScore = parseInt(document.getElementById('away-score').value);
            
            try {
                await dbAPI.updateMatchScore(currentMatch.id, homeScore, awayScore);
                showAlert('–°—á–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ', 'success');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                currentMatch.home_score = homeScore;
                currentMatch.away_score = awayScore;
                
            } catch (error) {
                console.error('Error updating match score:', error);
                showAlert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç–∞: ' + error.message, 'error');
            }
        }
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è –º–∞—Ç—á–∞
        async function addEvent(eventType) {
            if (!currentMatch) {
                showAlert('–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ç—á', 'error');
                return;
            }
            
            const playerId = document.getElementById('event-player').value;
            const teamId = document.getElementById('event-team').value;
            const minute = parseInt(document.getElementById('event-minute').value);
            const additionalTime = parseInt(document.getElementById('event-additional').value) || 0;
            const description = document.getElementById('event-description').value;
            const assistedBy = document.getElementById('event-assist').value || null;
            
            if (!playerId || !teamId || minute === '') {
                showAlert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è', 'error');
                return;
            }
            
            try {
                const eventData = {
                    player_id: parseInt(playerId),
                    team_id: parseInt(teamId),
                    event_type: eventType,
                    minute: minute,
                    additional_time: additionalTime,
                    description: description,
                    assisted_by_player_id: assistedBy ? parseInt(assistedBy) : null
                };
                
                await dbAPI.addMatchEvent(currentMatch.id, eventData);
                showAlert(`${DataUtils.getEventType(eventType)} –¥–æ–±–∞–≤–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ`, 'success');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏—è –º–∞—Ç—á–∞
                await loadMatchEvents(currentMatch.id);
                
                // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                document.getElementById('event-description').value = '';
                document.getElementById('event-assist').value = '';
                
            } catch (error) {
                console.error('Error adding match event:', error);
                showAlert('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏—è: ' + error.message, 'error');
            }
        }
        
        // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∏–≥—Ä–æ–∫–∞
        async function createPlayer() {
            const firstName = document.getElementById('player-first-name').value.trim();
            const lastName = document.getElementById('player-last-name').value.trim();
            const username = document.getElementById('player-username').value.trim();
            const position = document.getElementById('player-position').value;
            const telegramId = document.getElementById('player-telegram-id').value;
            
            if (!firstName) {
                showAlert('–ò–º—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è', 'error');
                return;
            }
            
            try {
                const playerData = {
                    first_name: firstName,
                    last_name: lastName,
                    username: username,
                    position: position,
                    telegram_id: telegramId ? parseInt(telegramId) : null
                };
                
                await dbAPI.createPlayer(playerData);
                showAlert('–ò–≥—Ä–æ–∫ —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ', 'success');
                
                // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                document.getElementById('player-first-name').value = '';
                document.getElementById('player-last-name').value = '';
                document.getElementById('player-username').value = '';
                document.getElementById('player-position').value = '';
                document.getElementById('player-telegram-id').value = '';
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤
                await loadAllData();
                
            } catch (error) {
                console.error('Error creating player:', error);
                showAlert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∏–≥—Ä–æ–∫–∞: ' + error.message, 'error');
            }
        }
        
        // –ü–µ—Ä–µ—Å—á–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        async function refreshStatistics() {
            try {
                showAlert('–ü–µ—Ä–µ—Å—á–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...', 'info');
                await dbAPI.refreshStatistics();
                showAlert('–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ', 'success');
            } catch (error) {
                console.error('Error refreshing statistics:', error);
                showAlert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: ' + error.message, 'error');
            }
        }
        
        // –ü–æ–∫–∞–∑ –∞–ª–µ—Ä—Ç–∞
        function showAlert(message, type = 'info') {
            const alertsContainer = document.getElementById('alerts');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type === 'info' ? 'success' : type}`;
            alert.textContent = message;
            
            alertsContainer.appendChild(alert);
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–±–∏—Ä–∞–µ–º –∞–ª–µ—Ä—Ç —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }
        
        // –ü–æ–º–µ—á–∞–µ–º —á—Ç–æ —ç—Ç–æ –∞–¥–º–∏–Ω
        window.isAdmin = true;
    </script>
</body>
</html>

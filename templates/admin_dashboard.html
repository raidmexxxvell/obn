<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å - Liga Obninska</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="/static/css/database-ui.css">
    <style>
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .admin-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .admin-section h2 {
            margin: 0 0 20px 0;
            color: #333;
            border-bottom: 2px solid #1976d2;
            padding-bottom: 8px;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #333;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .form-row {
            display: flex;
            gap: 16px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        .event-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .event-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .event-btn.goal { background: #4caf50; color: white; }
        .event-btn.assist { background: #2196f3; color: white; }
        .event-btn.yellow { background: #ff9800; color: white; }
        .event-btn.red { background: #f44336; color: white; }
        
        .current-events {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 12px;
            background: #f8f9fa;
        }
        
        .alert {
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 16px;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .lineup-section {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }
        
        .lineup-player {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            margin-bottom: 6px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #1976d2;
        }
        
        .lineup-player.captain {
            border-left-color: #ff9800;
        }
        
        .player-info {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .jersey-number {
            background: #1976d2;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            min-width: 30px;
            text-align: center;
        }
        
        .add-player-form {
            display: flex;
            gap: 8px;
            align-items: center;
            padding: 12px;
            background: #f1f3f4;
            border-radius: 6px;
            margin-top: 12px;
        }
        
        .add-player-form select,
        .add-player-form input {
            flex: 1;
            min-width: 120px;
        }
        
        .remove-player-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <h1>–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å - Liga Obninska</h1>
        
        <!-- –ê–ª–µ—Ä—Ç—ã -->
        <div id="alerts"></div>
        
        <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–∞–≤–∞–º–∏ –∫–æ–º–∞–Ω–¥ -->
        <div class="admin-section">
            <h2>–°–æ—Å—Ç–∞–≤—ã –∫–æ–º–∞–Ω–¥ –Ω–∞ –º–∞—Ç—á</h2>
            
            <div class="form-group">
                <label for="lineup-match-select">–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ç—á –¥–ª—è —Å–æ—Å—Ç–∞–≤–æ–≤:</label>
                <select id="lineup-match-select">
                    <option value="">–ó–∞–≥—Ä—É–∑–∫–∞ –º–∞—Ç—á–µ–π...</option>
                </select>
            </div>
            
            <div id="lineup-container" style="display: none;">
                <div class="form-row">
                    <div class="form-group">
                        <h3 id="home-team-name">–ö–æ–º–∞–Ω–¥–∞ –¥–æ–º–∞</h3>
                        <div class="lineup-section">
                            <h4>–û—Å–Ω–æ–≤–Ω–æ–π —Å–æ—Å—Ç–∞–≤</h4>
                            <div id="home-starting-eleven">
                                <!-- –û—Å–Ω–æ–≤–Ω–æ–π —Å–æ—Å—Ç–∞–≤ –¥–æ–º–∞ -->
                            </div>
                            <h4>–ó–∞–ø–∞—Å–Ω—ã–µ</h4>
                            <div id="home-substitutes">
                                <!-- –ó–∞–ø–∞—Å–Ω—ã–µ –¥–æ–º–∞ -->
                            </div>
                            <div class="add-player-form">
                                <select id="add-home-player">
                                    <option value="">–î–æ–±–∞–≤–∏—Ç—å –∏–≥—Ä–æ–∫–∞</option>
                                </select>
                                <input type="number" id="add-home-jersey" placeholder="–ù–æ–º–µ—Ä" min="1" max="99">
                                <select id="add-home-position">
                                    <option value="starting_eleven">–û—Å–Ω–æ–≤–∞</option>
                                    <option value="substitute">–ó–∞–ø–∞—Å–Ω–æ–π</option>
                                </select>
                                <button onclick="addPlayerToLineup('home')">–î–æ–±–∞–≤–∏—Ç—å</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <h3 id="away-team-name">–ö–æ–º–∞–Ω–¥–∞ –≤ –≥–æ—Å—Ç—è—Ö</h3>
                        <div class="lineup-section">
                            <h4>–û—Å–Ω–æ–≤–Ω–æ–π —Å–æ—Å—Ç–∞–≤</h4>
                            <div id="away-starting-eleven">
                                <!-- –û—Å–Ω–æ–≤–Ω–æ–π —Å–æ—Å—Ç–∞–≤ –≥–æ—Å—Ç–µ–π -->
                            </div>
                            <h4>–ó–∞–ø–∞—Å–Ω—ã–µ</h4>
                            <div id="away-substitutes">
                                <!-- –ó–∞–ø–∞—Å–Ω—ã–µ –≥–æ—Å—Ç–µ–π -->
                            </div>
                            <div class="add-player-form">
                                <select id="add-away-player">
                                    <option value="">–î–æ–±–∞–≤–∏—Ç—å –∏–≥—Ä–æ–∫–∞</option>
                                </select>
                                <input type="number" id="add-away-jersey" placeholder="–ù–æ–º–µ—Ä" min="1" max="99">
                                <select id="add-away-position">
                                    <option value="starting_eleven">–û—Å–Ω–æ–≤–∞</option>
                                    <option value="substitute">–ó–∞–ø–∞—Å–Ω–æ–π</option>
                                </select>
                                <button onclick="addPlayerToLineup('away')">–î–æ–±–∞–≤–∏—Ç—å</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç–æ–º –º–∞—Ç—á–∞ -->
        <div class="admin-section">
            <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç–æ–º –º–∞—Ç—á–∞</h2>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="match-select">–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ç—á:</label>
                    <select id="match-select">
                        <option value="">–ó–∞–≥—Ä—É–∑–∫–∞ –º–∞—Ç—á–µ–π...</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="home-score">–°—á–µ—Ç —Ö–æ–∑—è–µ–≤:</label>
                    <input type="number" id="home-score" min="0" value="0">
                </div>
                <div class="form-group">
                    <label for="away-score">–°—á–µ—Ç –≥–æ—Å—Ç–µ–π:</label>
                    <input type="number" id="away-score" min="0" value="0">
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="updateMatchScore()">–û–±–Ω–æ–≤–∏—Ç—å —Å—á–µ—Ç</button>
        </div>
        
        <!-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –º–∞—Ç—á–∞ -->
        <div class="admin-section">
            <h2>–°–æ–±—ã—Ç–∏—è –º–∞—Ç—á–∞</h2>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="event-player">–ò–≥—Ä–æ–∫:</label>
                    <select id="event-player">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä–æ–∫–∞</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="event-team">–ö–æ–º–∞–Ω–¥–∞:</label>
                    <select id="event-team">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="event-minute">–ú–∏–Ω—É—Ç–∞:</label>
                    <input type="number" id="event-minute" min="0" max="120" value="0">
                </div>
                <div class="form-group">
                    <label for="event-additional">–î–æ–ø. –≤—Ä–µ–º—è:</label>
                    <input type="number" id="event-additional" min="0" max="15" value="0">
                </div>
            </div>
            
            <div class="form-group">
                <label for="event-assist">–ü–µ—Ä–µ–¥–∞—á–∞ –æ—Ç (–µ—Å–ª–∏ –≥–æ–ª):</label>
                <select id="event-assist">
                    <option value="">–ù–µ—Ç –ø–µ—Ä–µ–¥–∞—á–∏</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="event-description">–û–ø–∏—Å–∞–Ω–∏–µ:</label>
                <textarea id="event-description" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ–±—ã—Ç–∏–∏"></textarea>
            </div>
            
            <div class="event-buttons">
                <button class="event-btn goal" onclick="addEvent('goal')">‚öΩ –ì–æ–ª</button>
                <button class="event-btn assist" onclick="addEvent('assist')">üÖ∞Ô∏è –ü–µ—Ä–µ–¥–∞—á–∞</button>
                <button class="event-btn yellow" onclick="addEvent('yellow_card')">üü® –ñ–µ–ª—Ç–∞—è</button>
                <button class="event-btn red" onclick="addEvent('red_card')">üü• –ö—Ä–∞—Å–Ω–∞—è</button>
            </div>
        </div>
        
        <!-- –¢–µ–∫—É—â–∏–µ —Å–æ–±—ã—Ç–∏—è –º–∞—Ç—á–∞ -->
        <div class="admin-section">
            <h2>–¢–µ–∫—É—â–∏–µ —Å–æ–±—ã—Ç–∏—è</h2>
            <div id="current-events" class="current-events">
                <p>–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ç—á –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–æ–±—ã—Ç–∏–π</p>
            </div>
        </div>
        
        <!-- –°–æ–∑–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–∞ -->
        <div class="admin-section">
            <h2>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ –∏–≥—Ä–æ–∫–∞</h2>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="player-first-name">–ò–º—è:</label>
                    <input type="text" id="player-first-name" required>
                </div>
                <div class="form-group">
                    <label for="player-last-name">–§–∞–º–∏–ª–∏—è:</label>
                    <input type="text" id="player-last-name">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="player-username">Username:</label>
                    <input type="text" id="player-username">
                </div>
                <div class="form-group">
                    <label for="player-position">–ü–æ–∑–∏—Ü–∏—è:</label>
                    <select id="player-position">
                        <option value="">–ù–µ —É–∫–∞–∑–∞–Ω–∞</option>
                        <option value="goalkeeper">–í—Ä–∞—Ç–∞—Ä—å</option>
                        <option value="defender">–ó–∞—â–∏—Ç–Ω–∏–∫</option>
                        <option value="midfielder">–ü–æ–ª—É–∑–∞—â–∏—Ç–Ω–∏–∫</option>
                        <option value="forward">–ù–∞–ø–∞–¥–∞—é—â–∏–π</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <label for="player-telegram-id">Telegram ID:</label>
                <input type="number" id="player-telegram-id">
            </div>
            
            <button class="btn btn-success" onclick="createPlayer()">–°–æ–∑–¥–∞—Ç—å –∏–≥—Ä–æ–∫–∞</button>
        </div>
        
        <!-- –î–µ–π—Å—Ç–≤–∏—è -->
        <div class="admin-section">
            <h2>–î–µ–π—Å—Ç–≤–∏—è</h2>
            
            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                <button class="btn btn-secondary" onclick="refreshStatistics()">–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
                <button class="btn btn-secondary" onclick="loadAllData()">–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
            </div>
        </div>

        <!-- –ú–∞—Å—Å–æ–≤—ã–π –∏–º–ø–æ—Ä—Ç —Å–æ—Å—Ç–∞–≤–æ–≤ -->
        <div class="admin-section">
            <h2>–ú–∞—Å—Å–æ–≤—ã–π –∏–º–ø–æ—Ä—Ç —Å–æ—Å—Ç–∞–≤–æ–≤</h2>
            <div class="form-group">
                <label for="bulk-lineup-match">–ú–∞—Ç—á:</label>
                <select id="bulk-lineup-match"></select>
            </div>
            <div class="form-row">
                <div class="form-group" style="flex:1;">
                    <label for="bulk-home">–°–æ—Å—Ç–∞–≤ (–¥–æ–º) ‚Äì –ø–æ –æ–¥–Ω–æ–º—É –∏–≥—Ä–æ–∫—É –≤ —Å—Ç—Ä–æ–∫–µ (–Ω–æ–º–µ—Ä + –∏–º—è, –∫–∞–ø–∏—Ç–∞–Ω: (C) –∏–ª–∏ *):</label>
                    <textarea id="bulk-home" placeholder="1 –ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω (C)&#10;10 –ü–µ—Ç—Ä–æ–≤&#10;7 –°–∏–¥–æ—Ä–æ–≤ *" style="min-height:160px;"></textarea>
                </div>
                <div class="form-group" style="flex:1;">
                    <label for="bulk-away">–°–æ—Å—Ç–∞–≤ (–≥–æ—Å—Ç–∏):</label>
                    <textarea id="bulk-away" placeholder="9 –°–º–∏—Ä–Ω–æ–≤&#10;5 –û—Ä–ª–æ–≤&#10;11 –ö—É–∑–Ω–µ—Ü–æ–≤" style="min-height:160px;"></textarea>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="bulk-mode">–†–µ–∂–∏–º:</label>
                    <select id="bulk-mode">
                        <option value="replace">–ó–∞–º–µ–Ω–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π</option>
                        <option value="append">–î–æ–±–∞–≤–∏—Ç—å (–±–µ–∑ —É–¥–∞–ª–µ–Ω–∏—è)</option>
                    </select>
                </div>
            </div>
            <button onclick="bulkSetLineups()">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ—Å—Ç–∞–≤—ã</button>
            <small>–ü–µ—Ä–≤—ã–µ 11 —Å—Ç—Ä–æ–∫ –∫–∞–∂–¥–æ–π —Å—Ç–æ—Ä–æ–Ω—ã –±—É–¥—É—Ç –æ—Ç–º–µ—á–µ–Ω—ã –∫–∞–∫ "–û—Å–Ω–æ–≤–∞" –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</small>
        </div>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let currentMatch = null;
        let allMatches = [];
        let allPlayers = [];
        let allTeams = [];
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('DOMContentLoaded', async function() {
            await loadAllData();
        });
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
        async function loadAllData() {
            try {
                showAlert('–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...', 'info');
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ –º–∞—Ç—á–∏ –∏–∑ API
                const matchesResponse = await fetch('/api/schedule');
                const scheduleData = await matchesResponse.json();
                
                // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –≤ —Å–ø–∏—Å–æ–∫ –º–∞—Ç—á–µ–π
                allMatches = [];
                if (scheduleData.tours) {
                    scheduleData.tours.forEach(tour => {
                        if (tour.matches) {
                            tour.matches.forEach(match => {
                                allMatches.push({
                                    id: `${match.home}_${match.away}_${match.date || match.datetime}`,
                                    home_team_name: match.home,
                                    away_team_name: match.away,
                                    match_date: match.datetime || match.date,
                                    home_score: 0,
                                    away_score: 0
                                });
                            });
                        }
                    });
                }
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–º–∞–Ω–¥—ã –∏–∑ API
                const teamsResponse = await fetch('/api/teams');
                const teamsData = await teamsResponse.json();
                allTeams = teamsData.teams.map((teamName, index) => ({
                    id: index + 1,
                    name: teamName
                }));
                
                // –°–æ–∑–¥–∞–µ–º —Å–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤ (–∑–∞–≥–ª—É—à–∫–∞ - –≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω—É–∂–Ω–æ API –¥–ª—è –∏–≥—Ä–æ–∫–æ–≤)
                allPlayers = [];
                for (let i = 1; i <= 50; i++) {
                    allPlayers.push({
                        id: i,
                        first_name: `–ò–≥—Ä–æ–∫${i}`,
                        last_name: `–§–∞–º–∏–ª–∏—è${i}`,
                        username: `player${i}`,
                        position: ['goalkeeper', 'defender', 'midfielder', 'forward'][i % 4]
                    });
                }
                
                populateMatchSelect();
                populatePlayerSelects();
                populateTeamSelect();
                
                showAlert('–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ', 'success');
                
            } catch (error) {
                console.error('Error loading data:', error);
                showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message, 'error');
            }
        }
        
        // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –º–∞—Ç—á–µ–π
        function populateMatchSelect() {
            const select = document.getElementById('match-select');
            const lineupSelect = document.getElementById('lineup-match-select');
            
            const options = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ç—á</option>' + 
                allMatches.map(match => 
                    `<option value="${match.id}">${match.home_team_name} vs ${match.away_team_name} (${formatDate(match.match_date)})</option>`
                ).join('');
            
            select.innerHTML = options;
            lineupSelect.innerHTML = options;
            
            select.addEventListener('change', onMatchSelect);
            lineupSelect.addEventListener('change', onLineupMatchSelect);
        }
        
        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã
        function formatDate(dateString) {
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('ru-RU');
            } catch (e) {
                return dateString;
            }
        }
        
        // –í—ã–±–æ—Ä –º–∞—Ç—á–∞ –¥–ª—è —Å–æ—Å—Ç–∞–≤–æ–≤
        function onLineupMatchSelect() {
            const matchId = document.getElementById('lineup-match-select').value;
            const container = document.getElementById('lineup-container');
            
            if (!matchId) {
                container.style.display = 'none';
                return;
            }
            
            const match = allMatches.find(m => m.id === matchId);
            if (match) {
                document.getElementById('home-team-name').textContent = match.home_team_name;
                document.getElementById('away-team-name').textContent = match.away_team_name;
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–µ–ª–µ–∫—Ç—ã –∏–≥—Ä–æ–∫–æ–≤ –¥–ª—è —Å–æ—Å—Ç–∞–≤–æ–≤
                populateLineupPlayerSelects();
                loadTeamLineups(match);
                
                container.style.display = 'block';
            }
        }
        
        // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–µ–ª–µ–∫—Ç–æ–≤ –∏–≥—Ä–æ–∫–æ–≤ –¥–ª—è —Å–æ—Å—Ç–∞–≤–æ–≤
        function populateLineupPlayerSelects() {
            const homeSelect = document.getElementById('add-home-player');
            const awaySelect = document.getElementById('add-away-player');
            
            const options = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä–æ–∫–∞</option>' +
                allPlayers.map(player => 
                    `<option value="${player.id}">${player.first_name} ${player.last_name || ''}</option>`
                ).join('');
            
            homeSelect.innerHTML = options;
            awaySelect.innerHTML = options;
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Å—Ç–∞–≤–æ–≤ –∫–æ–º–∞–Ω–¥
        async function loadTeamLineups(match) {
            try {
                const params = new URLSearchParams({home: match.home_team_name, away: match.away_team_name});
                const resp = await fetch('/api/lineup/list?' + params.toString());
                if (!resp.ok) throw new Error('HTTP ' + resp.status);
                const data = await resp.json();
                renderLineupSide('home', data.home);
                renderLineupSide('away', data.away);
            } catch (e) {
                console.error('loadTeamLineups error', e);
                document.getElementById('home-starting-eleven').innerHTML = '<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>';
                document.getElementById('home-substitutes').innerHTML = '<p>–û—à–∏–±–∫–∞</p>';
                document.getElementById('away-starting-eleven').innerHTML = '<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>';
                document.getElementById('away-substitutes').innerHTML = '<p>–û—à–∏–±–∫–∞</p>';
            }
        }
        function renderLineupSide(side, payload){
            const starters = document.getElementById(side+'-starting-eleven');
            const subs = document.getElementById(side+'-substitutes');
            starters.innerHTML = '';
            subs.innerHTML = '';
            if(!payload || !Array.isArray(payload.starting_eleven) || payload.starting_eleven.length===0){
                starters.innerHTML = '<p>–°–æ—Å—Ç–∞–≤ –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω</p>';
            } else {
                payload.starting_eleven.forEach(p => starters.appendChild(buildLineupPlayerElement(side,p)));
            }
            if(!payload || !Array.isArray(payload.substitutes) || payload.substitutes.length===0){
                subs.innerHTML = '<p>–ó–∞–ø–∞—Å–Ω—ã–µ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</p>';
            } else {
                payload.substitutes.forEach(p => subs.appendChild(buildLineupPlayerElement(side,p)));
            }
        }
        function buildLineupPlayerElement(side, rec){
            const el = document.createElement('div');
            el.className = 'lineup-player' + (rec.is_captain ? ' captain' : '');
            el.dataset.player = rec.player;
            el.innerHTML = `
                <div class="player-info">
                    <div class="jersey-number">${rec.jersey_number || ''}</div>
                    <div><strong>${rec.player}</strong><br><small>${rec.position === 'starting_eleven' ? '–û—Å–Ω–æ–≤–∞' : '–ó–∞–ø–∞—Å–Ω–æ–π'}</small></div>
                </div>
                <button class="remove-player-btn" onclick="removePlayerFromLineupAPI('${side}', '${rec.player.replace(/'/g,"&#39;")}')">–£–±—Ä–∞—Ç—å</button>`;
            return el;
        }
        async function addPlayerToLineup(team) {
            const matchId = document.getElementById('lineup-match-select').value;
            if(!matchId){ showAlert('–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ç—á', 'error'); return; }
            const match = allMatches.find(m => m.id === matchId);
            const playerSelect = document.getElementById(`add-${team}-player`);
            const jerseyInput = document.getElementById(`add-${team}-jersey`);
            const positionSelect = document.getElementById(`add-${team}-position`);
            const playerId = playerSelect.value;
            const jersey = jerseyInput.value;
            const position = positionSelect.value;
            if (!playerId || !jersey){ showAlert('–í—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä–æ–∫–∞ –∏ —É–∫–∞–∂–∏—Ç–µ –Ω–æ–º–µ—Ä', 'error'); return; }
            const player = allPlayers.find(p=>p.id==playerId);
            if(!player){ showAlert('–ò–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error'); return; }
            try {
                const fd = new FormData();
                fd.append('home', match.home_team_name);
                fd.append('away', match.away_team_name);
                fd.append('team', team);
                fd.append('player', `${player.first_name} ${player.last_name || ''}`.trim());
                fd.append('jersey_number', jersey);
                fd.append('position', position);
                const resp = await fetch('/api/lineup/add', {method:'POST', body: fd});
                if(!resp.ok){ throw new Error('HTTP '+resp.status); }
                const js = await resp.json();
                if(js.error){ throw new Error(js.error); }
                showAlert('–ò–≥—Ä–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω', 'success');
                playerSelect.value=''; jerseyInput.value='';
                loadTeamLineups(match);
            }catch(e){ console.error(e); showAlert('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è: '+e.message,'error'); }
        }
        async function removePlayerFromLineupAPI(side, playerName){
            const matchId = document.getElementById('lineup-match-select').value;
            if(!matchId){ return; }
            const match = allMatches.find(m => m.id === matchId);
            try {
                const fd = new FormData();
                fd.append('home', match.home_team_name);
                fd.append('away', match.away_team_name);
                fd.append('team', side);
                fd.append('player', playerName);
                const resp = await fetch('/api/lineup/remove', {method:'POST', body: fd});
                if(!resp.ok) throw new Error('HTTP '+resp.status);
                const js = await resp.json();
                if(js.error){ throw new Error(js.error); }
                showAlert('–ò–≥—Ä–æ–∫ —É–¥–∞–ª—ë–Ω', 'success');
                loadTeamLineups(match);
            }catch(e){ console.error(e); showAlert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: '+e.message,'error'); }
        }
        // –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º removePlayerFromLineup —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞—Ç—å
        function removePlayerFromLineup(btn){
            // legacy stub
        }
        // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–ø–∏—Å–∫–æ–≤ –∏–≥—Ä–æ–∫–æ–≤
        function populatePlayerSelects() {
            const playerSelect = document.getElementById('event-player');
            const assistSelect = document.getElementById('event-assist');
            
            playerSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä–æ–∫–∞</option>';
            assistSelect.innerHTML = '<option value="">–ù–µ—Ç –ø–µ—Ä–µ–¥–∞—á–∏</option>';
            
            allPlayers.forEach(player => {
                const option1 = document.createElement('option');
                option1.value = player.id;
                option1.textContent = DataUtils.formatPlayerName(player);
                playerSelect.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = player.id;
                option2.textContent = DataUtils.formatPlayerName(player);
                assistSelect.appendChild(option2);
            });
        }
        
        // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∫–æ–º–∞–Ω–¥
        function populateTeamSelect() {
            const select = document.getElementById('event-team');
            select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É</option>';
            
            allTeams.forEach(team => {
                const option = document.createElement('option');
                option.value = team.id;
                option.textContent = team.name;
                select.appendChild(option);
            });
        }
        
        // –í—ã–±–æ—Ä –º–∞—Ç—á–∞
        async function onMatchSelect() {
            const matchId = document.getElementById('match-select').value;
            if (!matchId) {
                currentMatch = null;
                document.getElementById('current-events').innerHTML = '<p>–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ç—á –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–æ–±—ã—Ç–∏–π</p>';
                return;
            }
            
            currentMatch = allMatches.find(m => m.id == matchId);
            if (currentMatch) {
                document.getElementById('home-score').value = currentMatch.home_score;
                document.getElementById('away-score').value = currentMatch.away_score;
                
                await loadMatchEvents(matchId);
            }
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π –º–∞—Ç—á–∞
        async function loadMatchEvents(matchId) {
            try {
                // –ü–æ–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥–ª—É—à–∫—É
                const eventsContainer = document.getElementById('current-events');
                eventsContainer.innerHTML = '<p>–°–æ–±—ã—Ç–∏—è –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –º–∞—Ç—á–∞ –ø–æ–∫–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã</p>';
                
            } catch (error) {
                console.error('Error loading match events:', error);
                document.getElementById('current-events').innerHTML = '<p class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–±—ã—Ç–∏–π</p>';
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç–∞ –º–∞—Ç—á–∞
        async function updateMatchScore() {
            if (!currentMatch) {
                showAlert('–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ç—á', 'error');
                return;
            }
            
            const homeScore = parseInt(document.getElementById('home-score').value);
            const awayScore = parseInt(document.getElementById('away-score').value);
            
            try {
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç–∞ —á–µ—Ä–µ–∑ API
                const formData = new FormData();
                formData.append('home', currentMatch.home_team_name);
                formData.append('away', currentMatch.away_team_name);
                formData.append('score_home', homeScore);
                formData.append('score_away', awayScore);
                
                const response = await fetch('/api/match/score/set', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    showAlert('–°—á–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ', 'success');
                    currentMatch.home_score = homeScore;
                    currentMatch.away_score = awayScore;
                } else {
                    throw new Error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç–∞');
                }
                
            } catch (error) {
                console.error('Error updating match score:', error);
                showAlert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç–∞: ' + error.message, 'error');
            }
        }
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è –º–∞—Ç—á–∞
        async function addEvent(eventType) {
            if (!currentMatch) {
                showAlert('–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ç—á', 'error');
                return;
            }
            
            const playerId = document.getElementById('event-player').value;
            const teamId = document.getElementById('event-team').value;
            const minute = parseInt(document.getElementById('event-minute').value);
            const additionalTime = parseInt(document.getElementById('event-additional').value) || 0;
            const description = document.getElementById('event-description').value;
            const assistedBy = document.getElementById('event-assist').value || null;
            
            if (!playerId || !teamId || minute === '') {
                showAlert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è', 'error');
                return;
            }
            
            try {
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ —á–µ—Ä–µ–∑ API
                const formData = new FormData();
                formData.append('home', currentMatch.home_team_name);
                formData.append('away', currentMatch.away_team_name);
                formData.append('team', teamId === '1' ? 'home' : 'away');
                formData.append('minute', minute);
                formData.append('player', document.getElementById('event-player').selectedOptions[0].text);
                formData.append('type', eventType);
                formData.append('note', description);
                
                const response = await fetch('/api/match/events/add', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    showAlert(`–°–æ–±—ã—Ç–∏–µ "${eventType}" –¥–æ–±–∞–≤–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ`, 'success');
                    await loadMatchEvents(currentMatch.id);
                    
                    // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                    document.getElementById('event-description').value = '';
                    document.getElementById('event-assist').value = '';
                } else {
                    throw new Error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏—è');
                }
                
            } catch (error) {
                console.error('Error adding match event:', error);
                showAlert('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏—è: ' + error.message, 'error');
            }
        }
        
        // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∏–≥—Ä–æ–∫–∞
        async function createPlayer() {
            const firstName = document.getElementById('player-first-name').value.trim();
            const lastName = document.getElementById('player-last-name').value.trim();
            const username = document.getElementById('player-username').value.trim();
            const position = document.getElementById('player-position').value;
            const telegramId = document.getElementById('player-telegram-id').value;
            
            if (!firstName) {
                showAlert('–ò–º—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è', 'error');
                return;
            }
            
            showAlert('–§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –∏–≥—Ä–æ–∫–∞ –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–æ–∑–∂–µ', 'info');
            
            // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
            document.getElementById('player-first-name').value = '';
            document.getElementById('player-last-name').value = '';
            document.getElementById('player-username').value = '';
            document.getElementById('player-position').value = '';
            document.getElementById('player-telegram-id').value = '';
        }
        
        // –ü–µ—Ä–µ—Å—á–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        async function refreshStatistics() {
            try {
                showAlert('–ü–µ—Ä–µ—Å—á–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...', 'info');
                
                const response = await fetch('/api/stats-table/refresh', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'refresh=1'
                });
                
                if (response.ok) {
                    showAlert('–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ', 'success');
                } else {
                    throw new Error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏');
                }
            } catch (error) {
                console.error('Error refreshing statistics:', error);
                showAlert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: ' + error.message, 'error');
            }
        }
        
        // –ü–æ–∫–∞–∑ –∞–ª–µ—Ä—Ç–∞
        function showAlert(message, type = 'info') {
            const alertsContainer = document.getElementById('alerts');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type === 'info' ? 'success' : type}`;
            alert.textContent = message;
            
            alertsContainer.appendChild(alert);
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–±–∏—Ä–∞–µ–º –∞–ª–µ—Ä—Ç —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }
        
        // –ü–æ–ø–æ–ª–Ω—è–µ–º —Å–µ–ª–µ–∫—Ç –º–∞—Ç—á–µ–π –¥–ª—è bulk –±–ª–æ–∫–∞ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
        const _origPopulateMatchSelect = populateMatchSelect;
        populateMatchSelect = function(){
            _origPopulateMatchSelect();
            const bulkSelect = document.getElementById('bulk-lineup-match');
            if (!bulkSelect) return;
            bulkSelect.innerHTML = document.getElementById('match-select').innerHTML;
        };
        async function bulkSetLineups(){
            const sel = document.getElementById('bulk-lineup-match');
            const val = sel.value;
            if(!val){ showAlert('–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ç—á', 'error'); return; }
            const match = allMatches.find(m=>m.id===val);
            if(!match){ showAlert('–ú–∞—Ç—á –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error'); return; }
            const homeTxt = document.getElementById('bulk-home').value.trim();
            const awayTxt = document.getElementById('bulk-away').value.trim();
            if(!homeTxt && !awayTxt){ showAlert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞', 'error'); return; }
            const mode = document.getElementById('bulk-mode').value;
            try {
                const fd = new FormData();
                fd.append('home', match.home_team_name);
                fd.append('away', match.away_team_name);
                fd.append('mode', mode);
                if(homeTxt) fd.append('roster_home', homeTxt);
                if(awayTxt) fd.append('roster_away', awayTxt);
                const resp = await fetch('/api/lineup/bulk_set', {method:'POST', body: fd});
                if(!resp.ok) throw new Error('HTTP '+resp.status);
                const js = await resp.json();
                if(js.error) throw new Error(js.error);
                showAlert('–ò–º–ø–æ—Ä—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω: –¥–æ–±–∞–≤–ª–µ–Ω–æ –¥–æ–º '+js.added.home+', –≥–æ—Å—Ç '+js.added.away, 'success');
                // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç –±–ª–æ–∫ —Å–æ—Å—Ç–∞–≤–æ–≤ –¥–ª—è —ç—Ç–æ–≥–æ –º–∞—Ç—á–∞ ‚Äî –æ–±–Ω–æ–≤–∏–º
                const curMatchLineup = document.getElementById('lineup-match-select').value;
                if(curMatchLineup === val){
                    loadTeamLineups(match);
                }
            } catch(e){
                console.error(e);
                showAlert('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: '+e.message, 'error');
            }
        }
        // –ü–æ–º–µ—á–∞–µ–º —á—Ç–æ —ç—Ç–æ –∞–¥–º–∏–Ω
        window.isAdmin = true;
    </script>
</body>
</html>
